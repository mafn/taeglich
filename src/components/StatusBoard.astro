---
import "@fontsource-variable/space-grotesk";
import "@fontsource-variable/jetbrains-mono";
import { generateTimeline, SERVICES } from "./status-board-engine";

interface Props {
  showPostmortem?: boolean;
  incidentLinkHref?: string;
  incidentLinkLabel?: string;
  date?: string;
}

const {
  showPostmortem = false,
  incidentLinkHref,
  incidentLinkLabel = "Read full incident report",
  date = "2026-02-09",
} = Astro.props;

const services = SERVICES;

// Generate deterministic timeline based on the date
const phases = generateTimeline(date);
---

<div
  class="statusRoot relative isolate min-h-screen overflow-x-clip font-['Space_Grotesk_Variable'] text-[#0b1220]"
  data-postmortem={showPostmortem ? "1" : "0"}
>
  <div
    class="pointer-events-none absolute inset-0 z-0 bg-[repeating-linear-gradient(0deg,rgba(0,0,0,0.018)_0px,rgba(0,0,0,0.018)_1px,transparent_1px,transparent_7px)] opacity-10"
  >
  </div>

  <div class="relative z-1 mx-auto max-w-5xl px-4 py-10 sm:py-14">
    <header class="mb-5">
      <div class="flex flex-wrap items-end justify-between gap-4">
        <div>
          <p
            class="flex flex-wrap items-center gap-2 text-[0.9rem] text-[#253041]"
          >
            <span class="mono font-['JetBrains_Mono_Variable']">STATUS</span>
            <span class="text-[#0b1220]/35" aria-hidden="true">/</span>
            <span class="opacity-70">public</span>
          </p>
          <h1
            class="mt-2 text-[clamp(1.7rem,3.3vw,2.5rem)] leading-[1.08] font-bold tracking-tight"
          >
            System Status
          </h1>
          <p class="mt-2.5 max-w-[70ch] leading-relaxed text-[#253041]">
            This page is always available. Accuracy may vary by weekday.
          </p>
        </div>

        <div
          class="min-w-[min(19.5rem,100%)] rounded-2xl border border-[#0b1220]/20 bg-linear-to-b from-white/90 to-white/70 p-4 shadow-2xl shadow-[#0b1220]/15"
          role="status"
          aria-label="Overall status"
        >
          <div class="flex items-center justify-between gap-3">
            <span
              class="pill pill--ok text-[0.78rem] font-extrabold"
              id="overallPill"
            >
              OPERATIONAL
            </span>
            <span
              class="mono text-[0.85rem] tracking-widest text-[#0b1220]/80"
              id="overallCode"
            >
              OK
            </span>
          </div>
          <p
            class="mt-2.5 leading-snug text-[#253041]"
            id="overallText"
            aria-live="polite"
            aria-atomic="true"
          >
            All systems operational.
          </p>
          <p
            class="mt-3 flex flex-wrap items-center gap-2 text-[0.85rem] text-[#0b1220]/80"
          >
            <span class="opacity-70">Local time</span>
            <span class="text-[#0b1220]/35" aria-hidden="true">•</span>
            <time
              class="mono font-['JetBrains_Mono_Variable']"
              id="localTime"
              datetime="">--:--</time
            >
          </p>

          <noscript>
            <p class="mt-2.5 text-[0.9rem] leading-tight text-[#0b1220]/80">
              JavaScript is disabled; this page cannot simulate weekday
              incidents.
            </p>
          </noscript>
        </div>
      </div>
    </header>

    <div class="grid gap-6">
      <section
        class="overflow-hidden rounded-[18px] border border-[#0b1220]/20 bg-white/95 shadow-2xl shadow-[#0b1220]/15 backdrop-blur-md"
        aria-labelledby="services-title"
      >
        <div
          class="border-b border-[#0b1220]/15 bg-linear-to-b from-white/95 to-white/75 px-4 pt-4 pb-2.5"
        >
          <h2
            id="services-title"
            class="text-[1.05rem] font-bold tracking-tight"
          >
            Services
          </h2>
          <p class="mt-1 text-[0.92rem] text-[#0b1220]/80">
            Unexpectedly many dependencies for "normal".
          </p>
        </div>

        <ul class="m-0 list-none p-0" aria-label="Service list">
          {
            services.map((svc) => (
              <li
                class="service group grid grid-cols-[1fr_auto] gap-4 border-t border-dashed border-[#0b1220]/15 px-4 py-4 transition-colors first:border-t-0 data-[state=degraded]:bg-[#9a3412]/5 data-[state=outage]:bg-[#b42318]/5"
                data-service={svc.key}
                data-state="operational"
              >
                <div class="serviceMain">
                  <p class="font-extrabold tracking-tight">{svc.name}</p>
                  <p class="mt-1 max-w-[70ch] text-[0.92rem] leading-relaxed text-[#0b1220]/80">
                    {svc.description}
                  </p>
                </div>
                <div class="flex items-start">
                  <span
                    class="servicePill inline-flex items-center justify-center rounded-full border border-[#0b1220]/20 bg-white/70 px-2 py-0.5 text-[0.76rem] font-extrabold tracking-wider text-[#0b1220]/90 uppercase group-data-[state=degraded]:border-[#9a3412]/35 group-data-[state=degraded]:bg-[#9a3412]/10 group-data-[state=degraded]:text-[#9a3412] group-data-[state=operational]:border-[#0f766e]/30 group-data-[state=operational]:bg-[#0f766e]/10 group-data-[state=operational]:text-[#0f766e] group-data-[state=outage]:border-[#b42318]/35 group-data-[state=outage]:bg-[#b42318]/10 group-data-[state=outage]:text-[#b42318]"
                    aria-label="Service status"
                  >
                    Operational
                  </span>
                </div>
              </li>
            ))
          }
        </ul>
      </section>

      <section
        class="card incident overflow-hidden rounded-[18px] border border-[#0b1220]/20 bg-white/95 shadow-2xl shadow-[#0b1220]/15 backdrop-blur-md"
        id="incidentCard"
        aria-labelledby="incident-title"
        hidden
      >
        <div
          class="flex items-center justify-between border-b border-[#0b1220]/15 bg-linear-to-b from-white/95 to-white/75 px-4 pt-4 pb-2.5"
        >
          <div>
            <h2
              id="incident-title"
              class="text-[1.05rem] font-bold tracking-tight"
            >
              Incident Feed
            </h2>
            <p class="mt-1 text-[0.92rem] text-[#0b1220]/80">
              Monday incidents are automatically detected in most regions.
            </p>
          </div>
          {
            incidentLinkHref && (
              <a
                id="incidentReportLink"
                class="hidden rounded-lg border border-[#0b3d91]/15 bg-[#0b3d91]/5 px-3 py-1.5 text-[0.85rem] font-bold text-[#0b3d91]/95 no-underline transition-colors hover:bg-[#0b3d91]/10 hover:underline focus-visible:rounded-lg focus-visible:outline-3 focus-visible:outline-offset-3 focus-visible:outline-[#0b3d91]/35"
                href={incidentLinkHref}
              >
                {incidentLinkLabel}
              </a>
            )
          }
        </div>

        <div class="px-4 pt-4 pb-4.5">
          <div class="mb-3.5 flex flex-wrap items-center justify-between gap-3">
            <div
              class="mono text-[0.85rem] tracking-widest text-[#0b1220]/55 uppercase"
              id="incidentId"
            >
              INC-{date}-MON
            </div>
          </div>

          <ol
            class="m-0 grid list-none gap-3 p-0"
            id="updates"
            aria-label="Incident updates"
          >
          </ol>
        </div>
      </section>

      <section
        class="card postmortem overflow-hidden rounded-[18px] border border-[#0b1220]/20 bg-white/95 shadow-2xl shadow-[#0b1220]/15 backdrop-blur-md"
        id="postmortemCard"
        aria-labelledby="postmortem-title"
        hidden
      >
        <div
          class="border-b border-[#0b1220]/15 bg-linear-to-b from-white/95 to-white/75 px-4 pt-4 pb-2.5"
        >
          <h2
            id="postmortem-title"
            class="text-[1.05rem] font-bold tracking-tight"
          >
            Postmortem
          </h2>
          <p class="mt-1 text-[0.92rem] text-[#0b1220]/80">
            Published after the incident was reviewed, re-reviewed, and made
            safe.
          </p>
        </div>

        <div class="px-4 pt-4 pb-4.5">
          <div class="mb-3.5 flex flex-wrap items-center justify-between gap-3">
            <div class="pill pill--ok text-[0.78rem] font-extrabold">
              RESOLVED
            </div>
            <div
              class="mono text-[0.85rem] tracking-widest text-[#0b1220]/78 uppercase"
            >
              <span id="postmortemStamp">Published</span>
              <span class="mx-1 text-[#0b1220]/35" aria-hidden="true">•</span>
              <span>RCA: approved</span>
            </div>
          </div>

          <div class="grid gap-4 lg:grid-cols-3">
            <div>
              <h3 class="text-[0.95rem] font-extrabold tracking-tight">
                Root Cause
              </h3>
              <p class="mt-1.5 leading-relaxed text-[#0b1220]/82">
                The weekend dependency reached end-of-life at 23:59 local time.
                Monday attempted to cold-start without warm cache.
              </p>
            </div>
            <div>
              <h3 class="text-[0.95rem] font-extrabold tracking-tight">
                Contributing Factors
              </h3>
              <ul class="mt-2 list-disc pl-4 leading-relaxed text-[#0b1220]/82">
                <li>Context switching without backpressure.</li>
                <li>Unbounded notifications.</li>
                <li>Friday deployments of ambitious plans.</li>
              </ul>
            </div>
            <div>
              <h3 class="text-[0.95rem] font-extrabold tracking-tight">
                Corrective Actions
              </h3>
              <dl class="mt-2 grid gap-2 text-[#0b1220]/82">
                <div
                  class="grid grid-cols-[5.7rem_1fr] items-baseline gap-3 border-t border-dashed border-[#0b1220]/15 pt-2 first:border-t-0 first:pt-0"
                >
                  <dt
                    class="mono text-[0.86rem] tracking-widest text-[#0b1220]/70 uppercase"
                  >
                    A-1
                  </dt>
                  <dd>Ship one small thing. Declare victory.</dd>
                </div>
                <div
                  class="grid grid-cols-[5.7rem_1fr] items-baseline gap-3 border-t border-dashed border-[#0b1220]/15 pt-2"
                >
                  <dt
                    class="mono text-[0.86rem] tracking-widest text-[#0b1220]/70 uppercase"
                  >
                    A-2
                  </dt>
                  <dd>Add a hard cap to meeting count.</dd>
                </div>
                <div
                  class="grid grid-cols-[5.7rem_1fr] items-baseline gap-3 border-t border-dashed border-[#0b1220]/15 pt-2"
                >
                  <dt
                    class="mono text-[0.86rem] tracking-widest text-[#0b1220]/70 uppercase"
                  >
                    A-3
                  </dt>
                  <dd>Treat inbox as a queue, not an identity.</dd>
                </div>
              </dl>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>
</div>

<script
  is:inline
  type="application/json"
  id="status-board-config"
  set:html={JSON.stringify({
    phases,
    showPostmortem,
    artifactDate: date,
  }).replaceAll("<", "\\u003c")}
/>

<script is:inline>
  (function () {
    const configEl = document.getElementById("status-board-config");
    const configRaw = configEl?.textContent || "{}";
    let config = {};
    try {
      config = JSON.parse(configRaw);
    } catch (e) {
      console.error("Failed to parse status-board-config", e);
    }
    const phases = Array.isArray(config.phases) ? config.phases : [];
    const showPostmortem = !!config.showPostmortem;
    const artifactDate = config.artifactDate || "2026-02-09";

    const overallPill = document.getElementById("overallPill");
    const overallCode = document.getElementById("overallCode");
    const overallText = document.getElementById("overallText");
    const localTimeEl = document.getElementById("localTime");
    const incidentCard = document.getElementById("incidentCard");
    const updatesEl = document.getElementById("updates");
    const postmortemCard = document.getElementById("postmortemCard");
    const postmortemStamp = document.getElementById("postmortemStamp");

    if (
      !overallPill ||
      !overallCode ||
      !overallText ||
      !localTimeEl ||
      !incidentCard ||
      !updatesEl ||
      !postmortemCard ||
      !postmortemStamp
    ) {
      return;
    }

    // Postmortem appears day after the artifact date
    const dObj = new Date(artifactDate);
    dObj.setDate(dObj.getDate() + 1);
    const POSTMORTEM_FROM = `${dObj.getFullYear()}-${String(dObj.getMonth() + 1).padStart(2, "0")}-${String(dObj.getDate()).padStart(2, "0")}`;

    function pad2(n) {
      return String(n).padStart(2, "0");
    }

    function getLocalYYYYMMDD() {
      const d = new Date();
      return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
    }

    function setLocalTime() {
      const now = new Date();
      const hh = pad2(now.getHours());
      const mm = pad2(now.getMinutes());
      localTimeEl.textContent = `${hh}:${mm}`;
      localTimeEl.setAttribute("datetime", now.toISOString());
    }

    setLocalTime();
    setInterval(setLocalTime, 30_000);

    const params = new URLSearchParams(window.location.search);
    const demo = (params.get("demo") || "").toLowerCase();
    const speed = (params.get("speed") || "").toLowerCase();
    const mondayParamRaw = params.get("monday");
    const hasMondayParam = params.has("monday");
    const mondayParam = (
      mondayParamRaw ?? (hasMondayParam ? "1" : "")
    ).toLowerCase();
    const mondayOverride = !hasMondayParam
      ? null
      : mondayParam === "0" ||
          mondayParam === "false" ||
          mondayParam === "no" ||
          mondayParam === "off"
        ? false
        : true;
    const forcedMonday =
      mondayOverride ??
      (demo === "incident"
        ? true
        : demo === "ok" || demo === "resolved"
          ? false
          : null);
    const forcedResolved = demo === "resolved";
    const isMonday = forcedMonday ?? new Date().getDay() === 1;

    // speed=fast is roughly 4 seconds per update
    // speed=medium is 10 seconds
    // default is 60 seconds
    const baseDelay =
      speed === "fast" ? 4000 : speed === "medium" ? 10000 : 60_000;

    // Start much faster if we are forcing Monday or in a speed mode
    const firstDelay =
      forcedMonday !== null || speed === "fast" || speed === "medium"
        ? 500
        : 60_000;

    function setServiceState(key, state, label) {
      const row = document.querySelector(`[data-service="${key}"]`);
      if (!row) return;
      row.dataset.state = state;
      const pill = row.querySelector(".servicePill");
      if (pill) pill.textContent = label;
    }

    function setOverall(state, code, text) {
      overallPill.textContent =
        state === "ok" ? "OPERATIONAL" : state.toUpperCase();
      overallPill.className = `pill pill--${state} text-[0.78rem] font-extrabold px-2.5 py-1 rounded-full border tracking-wider`;
      if (state === "ok") {
        overallPill.classList.add(
          "text-[#0f766e]",
          "border-[#0f766e]/35",
          "bg-[#0f766e]/10",
        );
      } else if (state === "degraded") {
        overallPill.classList.add(
          "text-[#9a3412]",
          "border-[#9a3412]/35",
          "bg-[#9a3412]/10",
        );
      } else if (state === "outage") {
        overallPill.classList.add(
          "text-[#b42318]",
          "border-[#b42318]/40",
          "bg-[#b42318]/10",
        );
      }
      overallCode.textContent = code;
      overallText.textContent = text;
    }

    function addUpdate(text, kind, timeOffset) {
      const item = document.createElement("li");
      item.className = `update update--${kind} grid grid-cols-[auto_1fr] gap-4 p-4 rounded-xl border border-[#0b1220]/10 bg-white shadow-sm transition-all duration-300 hover:shadow-md max-[520px]:grid-cols-1 max-[520px]:gap-2`;

      const icon = document.createElement("div");
      icon.className =
        "flex items-center justify-center w-8 h-8 rounded-full shrink-0 mt-0.5";

      if (kind === "warn") {
        item.classList.add("border-l-4", "border-l-[#b42318]", "bg-[#fff1f2]");
        icon.className += " bg-[#fee2e2] text-[#b42318]";
        icon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/></svg>`;
      } else if (kind === "ok") {
        item.classList.add("border-l-4", "border-l-[#0f766e]", "bg-[#f0fdf4]");
        icon.className += " bg-[#d1fae5] text-[#0f766e]";
        icon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>`;
      } else {
        item.classList.add("border-l-4", "border-l-[#0b3d91]", "bg-[#eff6ff]");
        icon.className += " bg-[#dbeafe] text-[#0b3d91]";
        icon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>`;
      }

      const content = document.createElement("div");
      content.className = "flex flex-col gap-1";

      const stamp = document.createElement("div");
      stamp.className =
        "mono text-[0.8rem] tracking-wider text-[#0b1220]/60 uppercase font-['JetBrains_Mono_Variable'] font-bold";

      // Calculate timestamp from 08:00 AM base
      const d = new Date();
      d.setHours(8, 0, 0, 0);
      d.setMinutes(d.getMinutes() + (timeOffset || 0));

      stamp.textContent = `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;

      const headline = document.createElement("p");
      headline.className =
        "font-bold text-[0.95rem] text-[#0b1220]/90 leading-snug";
      headline.textContent = text;

      content.appendChild(stamp);
      content.appendChild(headline);

      item.appendChild(icon);
      item.appendChild(content);
      updatesEl.prepend(item);
    }

    function resetOperational() {
      setOverall("ok", "OK", "All systems operational.");
      const rows = document.querySelectorAll("[data-service]");
      for (const row of rows) {
        row.dataset.state = "operational";
        const pill = row.querySelector(".servicePill");
        if (pill) pill.textContent = "Operational";
      }
    }

    function hideIncident() {
      incidentCard.hidden = true;
      updatesEl.replaceChildren();
    }

    function hidePostmortem() {
      postmortemCard.hidden = true;
    }

    function showPostmortemCard() {
      if (!showPostmortem) return;
      postmortemStamp.textContent = `Published ${POSTMORTEM_FROM}`;
      postmortemCard.hidden = false;
    }

    function startMondayIncident() {
      hidePostmortem();
      resetOperational();
      hideIncident();

      const isNaturalFlow = !hasMondayParam && speed === "" && demo === "";
      const now = new Date();
      // Assume incident starts at 08:00 AM local time
      const startTime = new Date(
        now.getFullYear(),
        now.getMonth(),
        now.getDate(),
        8,
        0,
        0,
      );
      const minutesSinceStart = Math.max(0, (now - startTime) / 60000);

      let idx = 0;

      function applyPhase(phase) {
        incidentCard.hidden = false;
        setOverall(phase.overall.state, phase.overall.code, phase.overall.text);
        if (Array.isArray(phase.changes)) {
          for (const change of phase.changes) {
            setServiceState(change.key, change.state, change.label);
          }
        }
        addUpdate(phase.update.text, phase.update.kind, phase.timeOffset);
      }

      function tick() {
        const phase = phases[idx];
        if (!phase) return; // Guard against undefined

        const isLastPhase = idx === phases.length - 1;
        const shouldStopForNaturalMonday =
          phase.isStabilized && !forcedMonday && !forcedResolved;

        // Catch-up logic for natural flow
        if (isNaturalFlow && phase.timeOffset <= minutesSinceStart) {
          applyPhase(phase);
          if (shouldStopForNaturalMonday || isLastPhase) {
            const link = document.getElementById("incidentReportLink");
            if (link) link.classList.remove("hidden");
            return;
          }
          idx++;
          tick();
          return;
        }

        const now = new Date();
        const minutesSinceStartNow = Math.max(0, (now - startTime) / 60000);

        const delay = isNaturalFlow
          ? (phase.timeOffset - minutesSinceStartNow) * 60000
          : idx === 0
            ? firstDelay
            : baseDelay;

        window.setTimeout(() => {
          applyPhase(phase);
          idx++;
          const isEndNow =
            idx >= phases.length ||
            (phases[idx].isStabilized && !forcedMonday && !forcedResolved);

          if (isEndNow) {
            const link = document.getElementById("incidentReportLink");
            if (link) link.classList.remove("hidden");
          }

          if (idx < phases.length) tick();
        }, delay);
      }

      tick();
    }

    function renderResolvedIfEligible() {
      resetOperational();
      hideIncident();
      const localDate = getLocalYYYYMMDD();
      const eligible = forcedResolved || localDate >= POSTMORTEM_FROM;
      if (eligible) {
        showPostmortemCard();
      } else {
        hidePostmortem();
      }
    }

    if (isMonday) {
      startMondayIncident();
    } else {
      renderResolvedIfEligible();
    }
  })();
</script>

<style>
  .statusRoot {
    background:
      radial-gradient(
        1200px 800px at 16% 6%,
        rgba(11, 61, 145, 0.12),
        transparent 55%
      ),
      radial-gradient(
        900px 700px at 84% 18%,
        rgba(180, 35, 24, 0.08),
        transparent 55%
      ),
      linear-gradient(180deg, #f4f6f8, #ffffff);
  }

  .pill {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.25rem 0.65rem;
    border-radius: 999px;
    border: 1px solid rgba(11, 18, 32, 0.2);
    background: rgba(255, 255, 255, 0.65);
    letter-spacing: 0.04em;
  }

  .pill--ok {
    border-color: rgba(15, 118, 110, 0.35);
    background: rgba(15, 118, 110, 0.1);
    color: #0f766e;
  }

  .pill--degraded {
    border-color: rgba(154, 52, 18, 0.35);
    background: rgba(154, 52, 18, 0.1);
    color: #9a3412;
  }

  .pill--outage {
    border-color: rgba(180, 35, 24, 0.4);
    background: rgba(180, 35, 24, 0.1);
    color: #b42318;
  }

  .mono {
    font-family:
      "JetBrains Mono Variable", ui-monospace, SFMono-Regular, Menlo, Monaco,
      Consolas, monospace;
  }

  #updates > :global(li) {
    animation: rise 300ms cubic-bezier(0.2, 0.8, 0.2, 1) both;
  }

  @keyframes rise {
    from {
      opacity: 0;
      transform: translateY(12px) scale(0.98);
    }
    to {
      opacity: 1;
      transform: translateY(0px) scale(1);
    }
  }

  @media (prefers-reduced-motion: reduce) {
    #updates > :global(li) {
      animation: none;
    }
  }
</style>
